# Merkaz_lib

An open library for file-sharing among students. A full-stack web application built with Flask (Python) backend and Angular frontend.

**Current Version:** 2.18.0 (as of 2025-12-14)

## Authors

- **Amir Labai** - Backend Developer
- **Yosef Nago** - Frontend Developer

## Features

- **User Authentication & Authorization**
  - User registration with admin approval system
  - Login/logout functionality
  - Password reset via email
  - Session refresh to sync latest user data
  - Role-based access control (Admin/User)
  - Session management with 15-minute timeout
  - Custom session invalidation system

- **File Management**
  - Browse and navigate folder structure
  - Search files and folders
  - Preview files 
  - Upload files (with admin approval workflow)
  - Download files and folders (folders as ZIP)
  - Create folders
  - Delete files/folders (admin only)
  - File type validation and security checks

- **Upload System**
  - Unique upload IDs for each file upload
  - Separate pending and completed upload logs
  - Admin approval workflow for uploaded files
  - File upload with folder structure preservation
  - User upload history tracking

- **Admin Dashboard**
  - View and manage user registrations
  - Approve/deny/re-pend user registrations
  - Toggle user roles and status
  - Approve/deny pending uploads
  - Edit upload destination paths
  - View system metrics and logs
  - Download log files
  - Manage user accounts
  - Track active sessions

- **Additional Features**
  - Suggestion submission system with cooldown levels
  - Activity logging (downloads, sessions, suggestions)
  - Email notifications for user approvals/denials
  - Trash folder for deleted files
  - Responsive Angular frontend

## Backend structure

```
merkaz_backend/
├── app.py                        # Main application entry point
├── version.py                    # Application version (auto-generated by semantic-release)
├── config/
│   ├── config.py                 # Application configuration and environment settings
│   └── config_template.py       # Configuration template for reference
│
├── controllers/                  # Controller layer (Flask routes / API endpoints)
│   ├── auth_controller.py        # User authentication and session routes
│   ├── files_controller.py       # File browsing, download, search, and preview endpoints
│   ├── uploads_controller.py     # File upload endpoints
│   └── admin_controller.py       # Admin dashboard endpoints
│
├── services/                     # Business logic layer
│   ├── auth_service.py           # Authentication and session handling
│   ├── file_service.py           # File management and validation
│   ├── upload_service.py         # File upload logic and workflow
│   ├── admin_service.py          # Admin operations, approvals, and reports
│   └── mail_service.py           # Email sending and notifications
│
├── repositories/                 # Data access layer
│   ├── user_repository.py        # Read/write user data (CSV or DB)
│   ├── upload_repository.py      # Manage upload logs and data
│   ├── download_repository.py    # Manage download history
│   ├── session_repository.py     # Handle session logs
│   └── suggestion_repository.py  # Manage user suggestions
│
├── models/                       # Entity and data models
│   ├── user_entity.py            # User entity definition (Flask-Login compatible)
│   ├── upload_entity.py          # Upload entity definition
│   ├── log_entity.py             # Base log record structure
│   └── __init__.py
│
├── utils/                        # Utility and helper functions
│   ├── file_utils.py             # File operations and MIME validation
│   ├── csv_utils.py              # CSV read/write utilities
│   ├── log_utils.py              # Logging helper functions
│   ├── logger_config.py         # Logging configuration and setup
│   └── path_utils.py             # Path and directory management
│
├── dev_toolkit/                  # Development and maintenance tools
│   ├── run_ngrok.py              # Ngrok tunnel launcher
│   ├── migrate_user_ids.py      # User ID migration utility
│   ├── set_boss_admin.py        # Set boss admin status (CLI)
│   ├── set_boss_admin_gui.py    # Set boss admin status (GUI)
│   └── dev_log_share_files.py   # Development logging utilities
│
└── __init__.py
```
## Frontend structure
```
merkaz-frontend/
├── src/
│   ├── app/
│   │   ├── components/                   # Main feature components
│   │   │   ├── dashborad/                # Dashboard (note: typo in folder name)
│   │   │   │   ├── admin-dash/           # Admin dashboard components
│   │   │   │   │   ├── users/           # User management
│   │   │   │   │   ├── pending/         # Pending user approvals
│   │   │   │   │   ├── denied/          # Denied user registrations
│   │   │   │   │   ├── uploads/         # Upload management
│   │   │   │   │   ├── metrics/         # System metrics
│   │   │   │   │   └── admin-dash-shared.css
│   │   │   │   ├── dashboard.component.css
│   │   │   │   ├── dashboard.component.html
│   │   │   │   └── dashboard.component.ts
│   │   │   │
│   │   │   ├── forgotpass/               # Forgot password page
│   │   │   │   ├── forgotpass.component.css
│   │   │   │   ├── forgotpass.component.html
│   │   │   │   └── forgotpass.component.ts
│   │   │   │
│   │   │   ├── login/                    # Login page
│   │   │   │   ├── login.component.css
│   │   │   │   ├── login.component.html
│   │   │   │   └── login.component.ts
│   │   │   │
│   │   │   ├── register/                 # User registration page
│   │   │   │   ├── register.component.css
│   │   │   │   ├── register.component.html
│   │   │   │   └── register.component.ts
│   │   │   │
│   │   │   ├── resetpass/                # Password reset page
│   │   │   │   ├── reset-pass.component.css
│   │   │   │   ├── reset-pass.component.html
│   │   │   │   └── reset-pass.component.ts
│   │   │   │
│   │   │   └── uploads/                  # Uploads and user files
│   │   │       ├── my-uploads.component.css
│   │   │       ├── my-uploads.component.html
│   │   │       ├── my-uploads.component.ts
│   │   │       ├── upload-file.component.css
│   │   │       ├── upload-file.component.html
│   │   │       └── upload-file.component.ts
│   │   │
│   │   ├── interceptors/
│   │   │   └── auth.interceptor.ts       # HTTP interceptor for auth headers
│   │   │
│   │   ├── services/
│   │   │   ├── auth.guard.ts             # Route guard for authentication
│   │   │   └── auth.service.ts           # Authentication and user session service
│   │   │
│   │   ├── app.config.ts                 # Global app configuration
│   │   ├── app.routes.ts                 # Angular routing configuration
│   │   ├── app.css                       # Global styling
│   │   ├── app.html                      # Root template
│   │   ├── app.ts                        # Root component / bootstrap
│   │   └── version.ts                    # Application version (auto-generated)
│   │
│   ├── assets/                           # Static assets (icons, images)
│   ├── custom.scss                       # Global SCSS styles
│   ├── styles.css                        # Additional global styles
│   └── index.html                        # Main HTML entry point
```

## Installation

### Prerequisites

- **Python 3.7+** (Python 3.9+ recommended)
- **Node.js 14+** and npm
- **Angular CLI** (for frontend development) - Version 20.3.6+

### Backend Setup

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd Librery_Server
   ```

2. **Create and activate virtual environment**
   ```bash
   python -m venv .venv
   ```

   On Windows (PowerShell):
   ```bash
   .venv\Scripts\Activate.ps1
   ```
   
   If you encounter an execution policy error:
   ```bash
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
   ```

   On Linux/Mac:
   ```bash
   source .venv/bin/activate
   ```

3. **Install Python dependencies**
   ```bash
   pip install -r requirements.txt
   ```

   Note: If you encounter encoding issues, you may need to install dependencies manually from `venv_prerequsites.txt`

4. **Configure the application**
   
   The configuration file should be created at `merkaz_backend/config/config.py`. A template file (`merkaz_backend/config/config_template.py`) is provided for reference.
   
   Edit `merkaz_backend/config/config.py` to set:
   - Secret keys for sessions and tokens
   - Mail server configuration (Gmail SMTP settings)
   - File paths and folder names
   - Allowed file extensions
   
   **Note**: On first run, the application will automatically create the necessary directories (`merkaz_server/data/`, `merkaz_server/logs/`, `merkaz_server/server_files/`) and initialize CSV log files.

5. **Run the backend server**
   ```bash
   cd merkaz_backend
   python app.py
   ```
   
   The server will start on `http://localhost:8000` using Waitress.

### Frontend Setup

1. **Install Node.js**
   
   Download and install from: https://nodejs.org
   
   Verify installation:
   ```bash
   node -v
   npm -v
   ```

2. **Install Angular CLI globally**
   ```bash
   npm install -g @angular/cli
   ```

3. **Navigate to frontend directory**
   ```bash
   cd merkaz-frontend
   ```

4. **Install frontend dependencies**
   ```bash
   npm install
   ```

5. **Run the development server**
   ```bash
   ng serve
   ```
   
   The frontend will be available at `http://localhost:4200`

## Technology Stack

### Backend
- **Framework**: Flask 3.1.2 (Python)
- **Server**: Waitress 3.0.2 (WSGI server)
- **Data Storage**: CSV files (no database required)
- **Email**: Flask-Mail 0.10.0 with Gmail SMTP
- **Security**: Werkzeug 3.1.3 (password hashing, session management)
- **File Validation**: python-magic-bin 0.4.14 (MIME type checking)
- **CORS**: flask-cors 6.0.1
- **Rate Limiting**: Flask-Limiter 3.8.0
- **Utilities**: pandas 2.3.3, openpyxl 3.1.5

### Frontend
- **Framework**: Angular 20.3.0
- **UI Components**: Angular Material 20.2.14
- **Build Tool**: Angular CLI 20.3.6
- **TypeScript**: 5.9.2
- **RxJS**: 7.8.0

## Configuration

### Backend Configuration (`merkaz_backend/config/config.py`)

Key configuration options:

- **Secret Keys**: `SUPER_SECRET_KEY` and `TOKEN_SECRET_KEY` are automatically generated using `os.urandom()`, but can be customized for production
- **Mail Settings**: Configure Gmail SMTP settings for email notifications
- **File Paths**: All paths are automatically resolved relative to the project root. Data, logs, and server files are stored in the `merkaz_server/` directory
- **Allowed Extensions**: Modify `ALLOWED_EXTENSIONS` and `VIDEO_EXTENSIONS` as needed
- **File Size Limits**: Adjust `MAX_CONTENT_LENGTH` and `MAX_VIDEO_CONTENT_LENGTH`

**Note**: A template configuration file (`config_template.py`) is available in the same directory for reference. The actual `config.py` uses dynamic path resolution and includes additional settings for ID sequence management.

### Frontend Configuration

The frontend is configured to connect to `http://localhost:8000` by default. Update API endpoints in components if using a different backend URL.

## Running the Application

### Development Mode

1. **Start the backend server** (from `merkaz_backend/`):
   ```bash
   python app.py
   ```

2. **Start the frontend** (from `merkaz-frontend/`):
   ```bash
   ng serve
   ```

3. **Access the application**:
   - Frontend (Angular dev server): http://localhost:4200
   - Backend API: http://localhost:8000

**Note**: In development, the frontend runs separately on port 4200. In production, the backend serves the Angular build from the same port (8000).

### Production Deployment

**Important**: In production, the Flask backend serves both the API and the Angular frontend from the same port. The backend automatically detects and serves the Angular build from `merkaz-frontend/dist/angular/browser/` if it exists.

**Production Setup Steps:**

1. **Build the Angular frontend**:
   ```bash
   cd merkaz-frontend
   ng build --configuration production
   ```
   This creates the production build in `merkaz-frontend/dist/angular/browser/`

2. **Start the backend server** (from `merkaz_backend/`):
   ```bash
   python app.py
   ```
   The server will automatically serve:
   - API endpoints (e.g., `/login`, `/browse`, `/admin/*`)
   - Angular frontend (all other routes serve the Angular SPA)

3. **Access the application**:
   - Both frontend and API are available at: `http://localhost:8000`
   - API routes take precedence over Angular routes

**Additional Production Considerations:**
- Using a production WSGI server (Waitress is already configured)
- Setting up proper HTTPS
- Configuring environment variables for sensitive data
- Using a reverse proxy (nginx, Apache) if needed
- The backend serves static Angular files, so no separate frontend server is required

## API Endpoints Overview

For detailed API documentation, see [documentation/api-reference.md](documentation/api-reference.md).

### Authentication
- `POST /login` - User login
- `POST /register` - User registration
- `POST /logout` - User logout
- `POST /forgot-password` - Request password reset
- `POST /reset-password/<token>` - Reset password with token
- `GET /refresh-session` - Refresh user session with latest data

### File Management
- `GET /browse` - Browse root directory
- `GET /browse/<path>` - Browse specific directory
- `GET /download/file/<path>` - Download file
- `GET /download/folder/<path>` - Download folder as ZIP
- `GET /preview/<path>` - Preview file (if supported)
- `GET /search` - Search files and folders
- `POST /create_folder` - Create new folder
- `POST /delete/<path>` - Delete file/folder (admin only)

### Uploads
- `POST /upload` - Upload file(s)
- `GET /my_uploads` - Get user's upload history
- `GET /admin/uploads` - Get pending uploads (admin only)
- `POST /admin/move_upload/<path:filename>` - Approve and move upload (admin only)
- `POST /admin/decline_upload/<path:filename>` - Decline upload (admin only)
- `POST /admin/edit_upload_path/` - Edit upload destination path (admin only)

### Admin
- `GET /admin/metrics` - System metrics and log file information
- `GET /admin/metrics/download/<log_type>` - Download log files (admin only)
- `GET /admin/users` - User management (list all users)
- `GET /admin/pending` - Pending user registrations
- `GET /admin/denied` - Denied user registrations
- `POST /admin/approve/<email>` - Approve user registration
- `POST /admin/deny/<email>` - Deny user registration
- `POST /admin/re-pend/<email>` - Move user back to pending status
- `POST /admin/toggle-role/<email>` - Toggle user role (admin/user)
- `POST /admin/toggle-status/<email>` - Toggle user status (active/inactive)
- `POST /admin/heartbeat` - Update user's active session timestamp

### Suggestions
- `POST /suggest` - Submit suggestion (with cooldown system)

## Upload System Improvements

The upload system has been enhanced with:

- **Unique Upload IDs**: Each upload receives a unique identifier for tracking
- **Separate Log Files**: 
  - `upload_pending_log.csv` - Files awaiting admin approval
  - `upload_completed_log.csv` - Files that have been approved and moved
  - Prevents duplicate entries and ensures accurate status tracking
- **Improved Tracking**: Admin can see exactly which files are pending approval
- **Better History**: Users can view their complete upload history with accurate status

## Ngrok Setup (Optional)

To expose the local server to the internet for testing:

### Installation on Windows

**Option 1 - Using winget (Recommended):**
```powershell
winget install ngrok.ngrok
```

**Option 2 - Using Chocolatey:**
```powershell
choco install ngrok
```

**Option 3 - Manual Installation:**
1. Visit: https://dashboard.ngrok.com/get-started/setup
2. Download ngrok for Windows
3. Extract `ngrok.exe` to a folder (e.g., `C:\ngrok`)
4. Add that folder to your system PATH:
   - Press `Win+X` and select "System"
   - Click "Advanced system settings"
   - Click "Environment Variables"
   - Under "System variables", find "Path" and click "Edit"
   - Click "New" and add the folder path (e.g., `C:\ngrok`)
   - Click "OK" on all dialogs
5. Restart your terminal/PowerShell
6. Verify installation: `ngrok version`

### Running Ngrok

After installation, you can use the provided script:
```bash
python merkaz_backend/dev_toolkit/run_ngrok.py [BACKEND_PORT]
```

Or run ngrok manually:
```bash
ngrok http 8000
```

This creates a public URL that tunnels to your local server.

**Note**: 
- The ngrok script only requires `BACKEND_PORT` because the Flask backend serves both the API and Angular frontend from the same port (8000 by default)
- The ngrok script is located in `merkaz_backend/dev_toolkit/` along with other development utilities
- When using ngrok, both the frontend and API will be accessible through the same tunnel URL

## Development Notes

### Development Tools (`merkaz_backend/dev_toolkit/`)

The project includes several development and maintenance utilities:

- **`run_ngrok.py`** - Automatically launches ngrok tunnel for local development
- **`migrate_user_ids.py`** - Utility to migrate user IDs in the database
- **`set_boss_admin.py`** - CLI tool to set boss admin status for users
- **`set_boss_admin_gui.py`** - GUI tool to set boss admin status for users
- **`dev_log_share_files.py`** - Development utilities for logging and file sharing

### Documentation

Comprehensive documentation is available in the `documentation/` directory:

- **API Reference**: [documentation/api-reference.md](documentation/api-reference.md)
- **Architecture**: [documentation/architecture.md](documentation/architecture.md)
- **Setup Guide**: [documentation/setup.md](documentation/setup.md)
- **Configuration**: [documentation/configuration.md](documentation/configuration.md)
- **Development**: [documentation/development.md](documentation/development.md)
- **Production Build**: [PRODUCTION_BUILD.md](PRODUCTION_BUILD.md)
- **New Computer Setup**: [SETUP_NEW_COMPUTER.md](SETUP_NEW_COMPUTER.md)

Auto-generated documentation for backend modules is available in `documentation/autogen/merkaz_backend/`.

### Generating Requirements File
```bash
pip freeze > requirements.txt
```

### Database Files
User data and activity logs are stored in CSV format within the `merkaz_server/` directory:
- `merkaz_server/data/auth_users.csv` - Authenticated users
- `merkaz_server/data/new_users.csv` - Pending user registrations
- `merkaz_server/data/denied_users.csv` - Denied registrations
- `merkaz_server/data/password_reset.csv` - Password reset tokens
- `merkaz_server/data/user_id_sequence.txt` - User ID sequence counter
- `merkaz_server/logs/` - Various activity logs (session, download, upload, suggestion logs)
- `merkaz_server/server_files/files_to_share/` - Approved shared files
- `merkaz_server/server_files/uploads/` - Pending uploads awaiting approval
- `merkaz_server/server_files/trash/` - Deleted files

### File Upload Flow
1. User uploads file → Saved in `merkaz_server/server_files/uploads/` directory (flat structure)
2. Entry created in `merkaz_server/logs/upload_pending_log.csv` with unique upload ID
3. Admin reviews pending uploads via admin dashboard
4. Admin approves → File moved to `merkaz_server/server_files/files_to_share/`, entry moved to `merkaz_server/logs/upload_completed_log.csv`
5. Admin declines → File deleted, entry moved to `merkaz_server/logs/declined_log.csv`

## Security Considerations

- **Secret Keys**: While secret keys are automatically generated, review and customize them for production if needed
- **Mail Credentials**: Never commit `config.py` with real mail credentials to version control. Use environment variables or secure configuration management
- **HTTPS**: Use HTTPS in production
- **Input Validation**: Implement proper input validation (already included in the application)
- **Regular Updates**: Keep dependencies updated
- **File Upload Restrictions**: Review and adjust `ALLOWED_EXTENSIONS` and file size limits as needed
- **CORS Configuration**: Update CORS origins in `app.py` for production to restrict access to authorized domains only

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.


## Project Structure

```
Server/
├── merkaz_backend/          # Flask backend application
├── merkaz-frontend/         # Angular frontend application
├── merkaz_server/           # Runtime data (logs, files, CSV databases)
│   ├── data/               # User data and sequences
│   ├── logs/               # Activity logs
│   └── server_files/       # Shared files, uploads, trash
├── documentation/          # Project documentation
├── scripts/                # Utility scripts (docs generation, versioning)
├── requirements.txt        # Python dependencies
├── package.json           # Root package.json (for semantic-release)
└── README.md              # This file
```

## Version Management

This project uses **semantic-release** for automated version management. Version information is automatically generated in:
- `merkaz_backend/version.py` (Python)
- `merkaz-frontend/src/app/version.ts` (TypeScript)

**Current Version:** 2.18.0

## Support

For issues or questions, please create an issue in the repository or contact the project maintainers.
